<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Manichino</title>
  <link rel="stylesheet" href="stile.css">
</head>
<body>

  <h2>Trascina i vestiti sul manichino</h2>
  <div class="container">
    
    <div id="manichino" ondragover="allowDrop(event)" ondrop="drop(event)">
      <div id="zona-testa" class="zona"></div>
      <div id="zona-busto" class="zona"></div>
      <div id="zona-over-busto" class="zona"></div>
      <div id="zona-gambe" class="zona"></div>
      <div id="zona-piedi" class="zona"></div>
    </div>

    <div class="area-vestiti">
      <img src="style/men/busto/magliaMarrone.png" id="maglietta-marrone" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/busto/magliaBianca.png" id="maglietta-bianca" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/busto/magliaBlu.png" id="maglietta-blu" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/busto/magliaNera.png" id="maglietta-nera" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/busto/magliaLanetta.png" id="maglietta-lanetta" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/overBusto/maglioneMaglietta.png" id="maglietta-maglione" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/overBusto/maglioneMarrone.png" id="maglietta-maglione-marrone" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/overBusto/giaccaLevis.png" id="camicia-jeans" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/overBusto/giaccaColorata.png" id="giacca-colorata" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/overBusto/giaccaJeans.png" id="giacca-jeans" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/overBusto/giaccaNike.png" id="giacca-nike" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/overBusto/giaccaPelle.png" id="giacca-pelle" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/busto/camicia.png" id="camicia" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/busto/camicetta.png" id="camicetta" class="vestito" draggable="true" ondragstart="drag(event)">

      <img src="style/men/gambe/cargoBeige.png" id="cargo" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/jeans.png" id="jeans" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/jeansGrigi.png" id="jeans-grigi" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/jeansNeri.png" id="jeans-neri" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/pantaloncinoJeans.png" id="pantaloncino-jeans" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/pantaloncinoJeansNero.png" id="pantaloncino-jeans-nero" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/pantaloniLarghiNeri.png" id="pantaloni-neri" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/pantaloniLino.png" id="pantaloni-lino" class="vestito" draggable="true" ondragstart="drag(event)">
      <img src="style/men/gambe/tuta.png" id="tuta" class="vestito" draggable="true" ondragstart="drag(event)">
    </div>
  </div>

  <div id="cestino" ondragover="allowDrop(event)" ondrop="dropInCestino(event)">
    üóëÔ∏è Trascina qui per rimuovere
  </div>

  <div id="colorPalette" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2);">
    <h3 style="margin: 0 0 15px 0; color: #333;">Scegli il colore</h3>
    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px;">
      <div class="color-option" style="background: #FF0000;" data-color="#FF0000"></div>
      <div class="color-option" style="background: #FF4500;" data-color="#FF4500"></div>
      <div class="color-option" style="background: #FFA500;" data-color="#FFA500"></div>
      <div class="color-option" style="background: #FFFF00;" data-color="#FFFF00"></div>
      <div class="color-option" style="background: #00FF00;" data-color="#00FF00"></div>
      <div class="color-option" style="background: #00FFFF;" data-color="#00FFFF"></div>
      <div class="color-option" style="background: #0000FF;" data-color="#0000FF"></div>
      <div class="color-option" style="background: #800080;" data-color="#800080"></div>
      <div class="color-option" style="background: #FF69B4;" data-color="#FF69B4"></div>
      <div class="color-option" style="background: #A52A2A;" data-color="#A52A2A"></div>
      <div class="color-option" style="background: #808080;" data-color="#808080"></div>
      <div class="color-option" style="background: #000000;" data-color="#000000"></div>
      <div class="color-option" style="background: #FFFFFF; border: 1px solid #ccc;" data-color="#FFFFFF"></div>
      <div class="color-option" style="background: #FFD700;" data-color="#FFD700"></div>
      <div class="color-option" style="background: #4B0082;" data-color="#4B0082"></div>
      <div class="color-option" style="background: #FF1493;" data-color="#FF1493"></div>
    </div>
    <div style="margin-top: 15px; text-align: right;">
      <button id="closePalette" style="padding: 5px 15px; border: none; background: #f0f0f0; border-radius: 5px; cursor: pointer;">Chiudi</button>
    </div>
  </div>

  <style>
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .color-option:hover {
      transform: scale(1.1);
    }
    #colorPalette {
      font-family: Arial, sans-serif;
    }
  </style>

  <script>
  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
    ev.dataTransfer.setData("isClone", "false");
    // quando faccio dragstart, viene salvato l'id e un flag "isClone": false
  }

  function dragIndumento(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
    ev.dataTransfer.setData("isClone", "true");
  }

  function drop(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const isClone = ev.dataTransfer.getData("isClone") === "true";
    const draggedElement = document.getElementById(data); // elemento originale o clone

    // Se clone e drop fuori da una zona valida ‚Üí rimuovi e ripristina originale
    const manichino = document.getElementById('manichino');
    const rectManichino = manichino.getBoundingClientRect(); // restituisce un oggetto che contiene le dimensioni del manichino
    if (
      ev.clientX < rectManichino.left ||
      ev.clientX > rectManichino.right ||
      ev.clientY < rectManichino.top ||
      ev.clientY > rectManichino.bottom
    ) {
      // Se √® un clone o comunque √® stato rilasciato fuori, va rimosso
      const originalId = data.replace("-clone", "");
      const original = document.getElementById(originalId);

      // Rendi di nuovo selezionabile l'originale
      if (original) {
        original.setAttribute("draggable", "true");
        original.style.opacity = "2";
        original.style.cursor = "grab";
      }

      // Se √® un clone, lo eliminiamo (non tocchiamo gli originali)
      if (isClone) {
        draggedElement.remove();
      }

      return;
    }

    
    // quando rilascio l'elemento sul manichino
    // Se sto manipolando un clone, original sar√† l'elemento originale da cui il clone √® stato creato (rimuove il suffisso -clone dall'elemento clonato, ritornando l'originale)
    // Se sto manipolando un originale, original sar√† l'elemento stesso che sto trascinando.

    const original = isClone ? document.getElementById(data.replace("-clone", "")) : draggedElement;
    const clone = draggedElement.cloneNode(true); // se non √® ancora un clone, qui clona l'elemento originale
    clone.classList.add('indumento');
    clone.setAttribute("id", original.id + "-clone");
    clone.setAttribute("draggable", "true");
    clone.addEventListener("dragstart", dragIndumento);

    const src = original.src;
    let zona = null;
    let zonaNome = null;

    if (src.includes('testa')) {
      zona = document.getElementById('zona-testa');
      zonaNome = "testa";
    } else if (src.includes('busto')) {
      zona = document.getElementById('zona-busto');
      zonaNome = "busto";
    } else if (src.includes('overBusto')) {
      zona = document.getElementById('zona-over-busto');
      zonaNome = "over-busto";
    } else if (src.includes('gambe')) {
      zona = document.getElementById('zona-gambe');
      zonaNome = "gambe";
    } else if (src.includes('piedi')) {
      zona = document.getElementById('zona-piedi');
      zonaNome = "piedi";
    }

    if (zonaNome) {
      const esistenti = manichino.querySelectorAll(`.indumento[data-zona="${zonaNome}"]`);
      esistenti.forEach(el => el.remove());
    }

    clone.setAttribute("data-zona", zonaNome);

    let zIndex = 10;
    if (src.includes('giacca') || src.includes('giubbotto') || src.includes('maglione')) {
      zIndex = 30;
    } else if (src.includes('maglia') || src.includes('camicetta') || src.includes('camicia')) {
      zIndex = 20;
    } else if (src.includes('jeans') || src.includes('pantaloni') || src.includes('pantaloncino') || src.includes('tuta') || src.includes('cargo')) {
      zIndex = 15;
    }
    clone.style.zIndex = zIndex;

    if (zona) {
      const zonaRect = zona.getBoundingClientRect();
      const xPx = zonaRect.left - rectManichino.left + (zona.clientWidth / 2 - 130);
      const yPx = zona.offsetTop;
      const vw = (xPx / window.innerWidth) * 100;
      const vh = (yPx / window.innerHeight) * 100;

      clone.style.position = 'absolute';
      clone.style.left = vw + 1.8 + 'vw';
      clone.style.top = vh + 'vh';
      clone.style.width = original.width * 0.29 + 'vh';
      clone.style.height = 'auto';

      manichino.appendChild(clone);
    } else {
      clone.style.visibility = 'hidden';
      document.body.appendChild(clone);
      const cloneRect = clone.getBoundingClientRect();
      const x = ev.clientX - rectManichino.left - cloneRect.width / 2;
      const y = ev.clientY - rectManichino.top - cloneRect.height / 2;
      const vw = (x / window.innerWidth) * 100;
      const vh = (y / window.innerHeight) * 100;

      clone.style.left = vw + 'vw';
      clone.style.top = vh + 'vh';
      clone.style.visibility = 'visible';
      document.body.removeChild(clone);
      clone.style.position = 'absolute';
      clone.style.width = original.width * 0.2 + 'vh';
      clone.style.height = 'auto';

      manichino.appendChild(clone);
    }

    
  }

  document.getElementById("manichino").addEventListener("click", function (event) {
    if (event.target.classList.contains('indumento')) {
      const cloneId = event.target.id;
      const originalId = cloneId.replace("-clone", "");
      const original = document.getElementById(originalId);

      if (original) {
        original.setAttribute("draggable", "true");
        original.style.opacity = "2";
        original.style.cursor = "grab";
      }

      event.target.remove();
    }
  });

  function dropInCestino(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const isClone = ev.dataTransfer.getData("isClone") === "true";

    if (isClone) {
      const clone = document.getElementById(data);
      const originalId = data.replace("-clone", "");
      const original = document.getElementById(originalId);

      if (original) {
        original.setAttribute("draggable", "true");
        original.style.opacity = "2";
        original.style.cursor = "grab";
      }

      if (clone) {
        clone.remove();
      }
    }
  }

  // Add this new function for handling color changes
  function handleColorChange(color, elementId) {
    const originalElement = document.getElementById(elementId);
    const cloneElement = document.getElementById(elementId + '-clone');
    
    // Store the clone's dimensions and position
    let cloneDimensions = null;
    if (cloneElement) {
      cloneDimensions = {
        width: originalElement.width * 0.29 + 'vh',
        position: cloneElement.style.position,
        left: cloneElement.style.left,
        top: cloneElement.style.top,
        zIndex: cloneElement.style.zIndex,
        dataZona: cloneElement.getAttribute('data-zona')
      };
    }
    
    // Create a canvas to modify the image color
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      canvas.width = img.width;
      canvas.height = img.height;
      
      // Draw the original image
      ctx.drawImage(img, 0, 0);
      
      // Get the image data
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      
      // Convert the selected color to HSL
      const r = parseInt(color.substr(1,2), 16) / 255;
      const g = parseInt(color.substr(3,2), 16) / 255;
      const b = parseInt(color.substr(5,2), 16) / 255;
      
      // Convert RGB to HSL
      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0; // achromatic
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      
      // Modify the image data to apply the new color while preserving lighting
      for(let i = 0; i < data.length; i += 4) {
        if(data[i+3] > 0) { // If pixel is not transparent
          // Get the original pixel's brightness
          const originalR = data[i] / 255;
          const originalG = data[i+1] / 255;
          const originalB = data[i+2] / 255;
          
          // Calculate original brightness
          const originalBrightness = (originalR + originalG + originalB) / 3;
          
          // Apply the new color while maintaining the original brightness
          const brightnessFactor = originalBrightness / 0.5; // Normalize to middle brightness
          
          // Convert HSL back to RGB with adjusted brightness
          let r1, g1, b1;
          
          if (s === 0) {
            r1 = g1 = b1 = l; // achromatic
          } else {
            const hue2rgb = (p, q, t) => {
              if (t < 0) t += 1;
              if (t > 1) t -= 1;
              if (t < 1/6) return p + (q - p) * 6 * t;
              if (t < 1/2) return q;
              if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
              return p;
            };
            
            const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - q;
            
            r1 = hue2rgb(p, q, h + 1/3);
            g1 = hue2rgb(p, q, h);
            b1 = hue2rgb(p, q, h - 1/3);
          }
          
          // Apply brightness adjustment
          r1 = Math.min(1, r1 * brightnessFactor);
          g1 = Math.min(1, g1 * brightnessFactor);
          b1 = Math.min(1, b1 * brightnessFactor);
          
          // Set the new color values
          data[i] = r1 * 255;     // Red
          data[i+1] = g1 * 255;   // Green
          data[i+2] = b1 * 255;   // Blue
        }
      }
      
      // Put the modified image data back
      ctx.putImageData(imageData, 0, 0);
      
      // Update both original and clone images
      const newImageUrl = canvas.toDataURL();
      
      // Update the original image
      originalElement.src = newImageUrl;
      
      // If there's a clone, update its source and restore dimensions
      if (cloneElement && cloneDimensions) {
        cloneElement.src = newImageUrl;
        cloneElement.style.width = cloneDimensions.width;
        cloneElement.style.position = cloneDimensions.position;
        cloneElement.style.left = cloneDimensions.left;
        cloneElement.style.top = cloneDimensions.top;
        cloneElement.style.zIndex = cloneDimensions.zIndex;
        cloneElement.setAttribute('data-zona', cloneDimensions.dataZona);
      }
    };
    
    img.src = originalElement.src;
  }

  // Add click event listeners for all clothing items
  document.querySelectorAll('.vestito').forEach(item => {
    item.addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent event from bubbling up
      const colorPalette = document.getElementById('colorPalette');
      colorPalette.style.display = 'block';
      colorPalette.dataset.currentElement = this.id;
    });
  });

  // Add click event listeners for color options
  document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
      const color = this.dataset.color;
      const elementId = document.getElementById('colorPalette').dataset.currentElement;
      handleColorChange(color, elementId);
      document.getElementById('colorPalette').style.display = 'none';
    });
  });

  // Close color palette when clicking the close button
  document.getElementById('closePalette').addEventListener('click', function() {
    document.getElementById('colorPalette').style.display = 'none';
  });

  // Close color palette when clicking outside
  document.addEventListener('click', function(e) {
    const colorPalette = document.getElementById('colorPalette');
    if (!colorPalette.contains(e.target) && e.target.classList.contains('vestito') === false) {
      colorPalette.style.display = 'none';
    }
  });

</script>


</body>
</html>
